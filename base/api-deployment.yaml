apiVersion: apps/v1
kind: Deployment
metadata:
  name: api
  namespace: penguincrm
spec:
  replicas: 2
  selector:
    matchLabels:
      app: api
  template:
    metadata:
      labels:
        app: api
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: "/metrics"
        prometheus.io/port: "3000"
    spec:
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: api
          image: ghcr.io/saigear99/penguincrm-api:latest
          ports:
            - containerPort: 3000
          envFrom:
            - secretRef:
                name: api-secrets
          env:
            - name: NODE_ENV
              value: "production"
            - name: PORT
              value: "3000"
            - name: ES_INDEX_NAME
              value: "emails_pjid_search"
            - name: MS_GRAPH_TENANT_ID
              value: "5ed8e9fb-d4b9-4deb-8823-0adf1b93d6d8"
            - name: MS_GRAPH_CLIENT_ID
              value: "cab85096-3c2c-43f6-ae3a-1cd502116289"
            - name: DOC_AI_PROCESSOR_ID
              value: "1a3f78805d1e9c3"
            - name: GCP_PROJECT_ID
              value: "gen-lang-client-0428922778"
            - name: NEXT_PUBLIC_API_BACKEND
              value: "http://api:3000"
            - name: NEXT_PUBLIC_API_BASE_URL
              value: "http://192.168.2.37:5001"
            - name: FRONTEND_URL
              value: "http://192.168.2.37,http://192.168.2.39,http://localhost,http://pre-sales-sys.got.co.th"
            # Python RAG Service (K8s internal)
            - name: PYTHON_RAG_API_URL
              value: "http://python:5000"
            # ⚠️ ragController.ts uses PYTHON_RAG_URL (not PYTHON_RAG_API_URL)
            - name: PYTHON_RAG_URL
              value: "http://python:5000/rag"
            # Python API URL for torBomController.ts, projectController.ts, compileProjectController.ts
            - name: PYTHON_API_URL
              value: "http://python:5000"
            # Python Server URL for ragController.ts (batch operations)
            - name: PYTHON_SERVER_URL
              value: "http://python:5000"
            # Python API Base URL for ServerRecController.ts, ClientRecController.ts
            - name: PYTHON_API_BASE_URL
              value: "http://python:5000"
            # Python Verifier URL for ServerRecController.ts
            - name: PYTHON_VERIFIER_BASE_URL
              value: "http://python:5000"
            # MinIO Configuration
            - name: MINIO_ENDPOINT
              value: "192.168.2.36"
            - name: MINIO_PORT
              value: "9000"
            - name: MINIO_BUCKET
              value: "penguin-crm"
            - name: MINIO_USE_SSL
              value: "false"
            # MinIO credentials
            - name: MINIO_ACCESS_KEY
              value: "penguin_minio"
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: api-secrets
                  key: MINIO_SECRET_KEY
                  optional: true

---
apiVersion: v1
kind: Service
metadata:
  name: api
  namespace: penguincrm
spec:
  type: NodePort
  ports:
    - port: 3000
      targetPort: 3000
      nodePort: 30000
  selector:
    app: api
